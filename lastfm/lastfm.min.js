(function(e){var h=[],p=[],c,m=0,q,s=location.host.split(".").reverse(),k=s[1]+"."+s[0];e.fn.lastfm=function(d){c=e.extend({},{username:"huntinggirled",apikey:"1b5830677a2a62d47c10b6916034a4b0",interval:1E3,reload:6E5,limit:50,default_count:5,page_count:5,onComplete:function(){}},d);c.default_count>c.page_count&&(c.page_count=c.default_count);c.page_count>c.limit&&(c.limit=c.page_count);d=e(this);d.after('<div id="more_track" />');d.getRecentTracks()};e.fn.getRecentTracks=function(){var d={relativeTime:function(a){a=
(new Date).getTime()/1E3-a;return 60>a?'<img src="http://'+k+'/js/lastfm/eq.gif" alt="\u518d\u751f\u4e2d" width="12" height="12" /> \u518d\u751f\u4e2d':180>a?'<img src="http://'+k+'/js/lastfm/eq.gif" alt="\u518d\u751f\u4e2d" width="12" height="12" /> \u518d\u751f\u4e2d':3600>a?parseInt(a/60).toString()+"\u5206\u524d":86400>a?parseInt(a/3600).toString()+"\u6642\u9593\u524d":parseInt(a/86400).toString()+"\u65e5\u524d"},stripSlashes:function(a){return(a+"").replace(/\0/g,"0").replace(/\\([\\'"])/g,"$1")},
elapsedTime:function(a){return a.find(".ctime").each(function(){var b=e(this).html(),a=d.relativeTime(e(this).data("datetime"));b!=a&&e(this).css("opacity",0).html(a).fadeTo("normal",1)})},printContent:function(a,b){if(null==b)return!1;var c=null!=b.image&&null!=b.image[0]["#text"]&&""!=b.image[0]["#text"]?d.stripSlashes(b.image[0]["#text"]):"http://"+k+"/js/lastfm/noimg_lfm.gif",l=null!=d.stripSlashes(b.url)?d.stripSlashes(b.url):"http://"+k+"/",f=null!=b.name?b.name:"unknown title",g=null!=b.artist&&
null!=b.artist["#text"]?b.artist["#text"]:"unknown artist",h=null!=b.date&&null!=b.date.uts?d.relativeTime(b.date.uts):"",v=null!=b["@attr"]&&null!=b["@attr"].nowplaying?'<img src="http://'+k+'/js/lastfm/eq.gif" alt="\u518d\u751f\u4e2d" width="12" height="12" /> \u518d\u751f\u4e2d':"",w=null!=b.date&&null!=b.date.uts?b.date.uts:parseInt((new Date).getTime()/1E3),n=p.length;p[n]=[g,f];a.append('<div id="atrack-'+n+'" style="clear:both;"><div class="ctime" data-datetime="'+w+'">'+v+h+'</div><a href="'+
l+'" title="'+g+" - "+f+'" target="_blank"><img src="'+c+'" class="widget-img-thumb" alt="'+g+" - "+f+'" onerror="this.src=(\'http://'+k+'/js/lastfm/noimg_lfm.gif\')" /></a><a href="'+l+'" title="'+g+" - "+f+'" target="_blank">'+(32<f.length?f.slice(0,32)+"...":f)+'</a><br /><a href="'+l+'" title="'+g+" - "+f+'" target="_blank">'+(32<g.length?g.slice(0,32)+"...":g)+'</a><div class="alist" style="clear:both;"></div><div class="ainfo" style="text-align:right;clear:both;opacity:0.2;"><a href="" onclick="$(this).closest(\'#atrack-'+
n+"').productSearch("+n+', 1);return false;">[Amazon\u3067\u691c\u7d22]</a></div></div>');a.children("#atrack-"+n).hover(function(){e(this).children(".ainfo").fadeTo("normal",1)},function(){e(this).children(".ainfo").fadeTo("normal",.2)});a.fadeTo("normal",1)},shiftItems:function(a){for(var b=0;b<c.page_count&&!(d.printContent(a,h.shift()),0>=h.length);b++);d.elapsedTime(r);e("#more_track").empty().append('<div style="text-align:right;"><a href="" onmouseover="$(\'#lastfm\').getRecentTracks();return false;">[\u3055\u3089\u306b\u8aad\u307f\u8fbc\u3080]</a></div>')},
eachThis:function(a){e("#more_track").empty().append('<div style="text-align:right;"><img src="http://'+k+'/js/lastfm/indi.gif" alt="\u8aad\u307f\u8fbc\u307f\u4e2d..." width="10" height="10" /> \u8aad\u307f\u8fbc\u307f\u4e2d...</div>');var b=m;if(1<=b&&h.length>=c.page_count){a.append('<div class="track" style="opacity:0.0;" />');var u=a.children(".track:last");d.shiftItems(u)}else return e.ajax({url:"http://ws.audioscrobbler.com/2.0/",data:{method:"user.getrecenttracks",user:c.username,api_key:c.apikey,
limit:0==m?c.default_count:c.limit,page:0==m?1:b,format:"json"},dataType:"jsonp",callback:"callback",timeout:5E3}).done(function(l,f){if(null==l||null==l.recenttracks)return e("#more_track").empty(),!1;if(0==b||1==b)h=[];h=h.concat(l.recenttracks.track);1==b&&h.splice(0,c.default_count);0==b&&a.empty();a.append('<div class="track" style="opacity:0.0;" />');var g=a.children(".track:last");d.shiftItems(g);m++}).fail(function(b,c,g){d.elapsedTime(a);e("#more_track").empty()}).always(function(b,a){})}},
r=e(this);d.eachThis(r);var t=(new Date).getTime();null!=q&&clearInterval(q);q=setInterval(function(){t+c.reload<(new Date).getTime()&&(m=0,d.eachThis(r),t=(new Date).getTime())},c.interval)};e.fn.productSearch=function(d,c){var h={productSearchComplete:function(b,a,c){var f=100<=b.result.TotalResults?100:b.result.TotalResults;0<f-10*c?a.children(".ainfo").empty().append('<a href="" onclick="$(this).closest(\'#atrack-'+d+"').productSearch("+d+", "+(c+1)+');return false;">[\u691c\u7d22\u7d50\u679c\u3042\u3068'+
(f-10*c)+"\u4ef6]</a>"):a.children(".ainfo").empty();a.children(".alist").append('<div class="apage" />');var g=a.children(".alist").children(".apage:last");g.css("opacity",0).fadeTo("normal",1);a=[];if(null==b.result.Item)return!1;null!=b.result.Item.length?a=b.result.Item:a[0]=b.result.Item;return e.each(a,function(b,a){var c=a.ItemAttributes.Title,d=a.ItemAttributes.Artist,e=a.DetailPageURL,f=a.SmallImage?a.SmallImage.URL:"",c=null!=d?d+" - "+c:c;if(null==f||""==f)f="http://"+k+"/js/lastfm/noimg_ama.gif";
g.append('<a href="'+decodeURIComponent(e)+'" title="'+c+'" target="_blank"><img src="'+f+'" class="widget-img-thumb" alt="'+c+'" /></a>')})}},a=e(this);a.children(".ainfo").empty().append('<img src="http://'+k+'/js/lastfm/indi.gif" alt="\u5546\u54c1\u691c\u7d22\u4e2d..." width="10" height="10" /> \u5546\u54c1\u691c\u7d22\u4e2d...');e.ajax({url:"http://"+k+"/amazon/request.php",data:{search_index:"Music",artist:p[d][0],title:p[d][1],item_page:c},dataType:"jsonp",callback:"callback",timeout:5E3}).done(function(b,
d){h.productSearchComplete(b,a,c)}).fail(function(b,c,d){a.children(".ainfo").empty()}).always(function(a,c){});return a}})(jQuery);